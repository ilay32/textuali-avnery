<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="{{language}}" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="{{language}}" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="{{language}}" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="{{language}}" class="ie9"> <![endif]-->
<!--[if !IE]><!-->

<html lang="{{language}}">
<!--<![endif]-->
<head>
	<meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width = 1050, user-scalable = no">
	<title>{{book_nicename}}</title>
	<link href="{{topdir}}bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="{{coddir}}css/basic.css" rel="stylesheet" type="text/css">
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
		<script src="html5shiv.min.js"></script>
		<script src="respond.min.js"></script>
	<![endif]-->
	<script src="{{topdir}}vendor/turnjs4/lib/hash.js" type="text/javascript"></script>
	</head>

<body>
    <div class="textuali-container" style="direction:rtl">
        <div class="row">
            <div class="text-center" >
                <div class="btn-group btn-group-xs">
                    {{#has_texts}}
                     <button title="show scan image of pages" type="button" id="showscans" class="btn btn-default mode-toggle" >
                        <span class="glyphicon glyphicon-picture"></span>
                     </button>
                      <button title="show pages as text" type="button" id="showhtmls" class="btn btn-default mode-toggle">
                        <span class="glyphicon glyphicon-font"></span>
                     </button>
                     {{/has_texts}}
                    <button title="zoom in" type="button" id="enlarge" class="btn btn-default" >
                        <span class="glyphicon glyphicon-resize-full"></span>
                     </button>
                </div>
                <div class="btn-group btn-group-xs">
                    <button title="next page" type="button" class="btn btn-default" id="flb-next">
                        <span class="glyphicon glyphicon-chevron-left"></span>
                    </button>
                    {{#toc}}
                    <button title="go to table of contents page" type="button" class="btn btn-default" id="totoc">
                        <span class="glyphicon glyphicon-list"></span>
                    </button>
                    {{/toc}}
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span> :go to
                    </button>
                    <button title="previous page" type="button" class="btn btn-default" id="flb-prev">
                        <span class="glyphicon glyphicon-chevron-right"/>
                    </button>
                    <ul class="dropdown-menu" role="menu" id="gotopage"></ul>
                </div>
                <div class="btn-group btn-group-xs">
                    <button title="download pdf" href="{{book_shortname}}.pdf" type="button" class="btn btn-default" id="download-pdf">
                        <span class="glyphicon glyphicon-download-alt"></span>
                    </button>
                    <button title="tag cloud" type="button" class="btn btn-default" id="tag-cloud">
                        <span class="glyphicon glyphicon-cloud"></span>
                    </button>
                    <button title="share this book" type="button" class="btn btn-default" id="share">
                        <span class="glyphicon glyphicon-transfer"></span>
                    </button>        
                </div>
                <div class="btn-group btn-group-xs">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        <span class="glyphicon glyphicon-search"></span>
                    </button>
                    <button title="previous menu" type="button" class="btn btn-default" id="flb-prev">
                        previous menu?
                    </button>   
                    <div class="dropdown-menu">
                        <input type="text" class="form-control" placeholder="search">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div id="flipbook-wrapper" class="col-md-12 text-center">
                <div class="flipbook-viewport">
                    <div class="flipbook-container">   
                        <div class="flipbook">
							{{#hard_cover}}
							<div class="hard" style="background-image:url(jpg/{{bookdir}}p000a.jpg)"></div>
							<div class="hard" style="background-image:url(jpg/{{bookdir}}p000b.jpg)"></div> 
							{{/hard_cover}}
							{{^hard_cover}}                             
							<div style="background-image:url(jpg/{{frontjpg}}); background-size: contain">
								<!--<div class="page-html hidden"></div> assuming the front never has html -->
							</div>
							{{/hard_cover}}          				
                        </div><!-- flipbook -->          
                   	</div>
                </div><!--flipbook-viewport -->
            </div>
        </div><!-- .row -->
    </div><!-- .container -->
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="{{topdir}}vendor/jquery-1.11.1.min.js" type="text/javascript"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{{topdir}}vendor/ie10-viewport-bug-workaround.js" type="text/javascript"></script>
    <script src="{{topdir}}vendor/turnjs4/extras/modernizr.2.5.3.min.js" type="text/javascript"></script>
    <script src="{{topdir}}bootstrap/js/bootstrap.min.js" type="text/javascript"></script> 
    <script type="text/javascript">
		$(window).resize(function() {
            var rememberme = $('.flipbook').turn('page');
            $('.flipbook').turn('destroy');
            loadApp();
            $('.flipbook').turn('page',rememberme);
        });

        $('#download-pdf').click(function() {
            var pdf = $(this).attr('href');
            if(undefined != pdf) {
                window.open(location.href+"{{authdir}}-{{bookdir}}-"+pdf, "{{book_nicename}} PDF", "width=600, height=400" );
            }
        });
        if('{{language}}' == 'he') {
			$('body').css('direction', 'rtl');
		}
		function page_files(page) {
			var zeros = '00', hard = false;
			if(page > 9) {
				zeros = '0';
			}
			if(page > 99) {
				zeros = '';
			}
			var filename = '{{bookdir}}p'+ zeros + page;
			if('{{hard_cover}}' == 'True' && page > {{pages}} - 2) {
				filename = '{{bookdir}}p999'+(page == {{pages}} ? 'z' : 'y');
				hard = true;
			} 
			return {jpg : 'jpg/'+ filename + '.jpg', html : 'html/' + filename + '.htm', hard : hard};
		}
			
		function loadPage(page, pageElement) {
			pageElement.css('background-image','url('+page_files(page).jpg+')');			
            foundHtml = false;
			if('{{has_texts}}' == 'True' ) {			
				$.ajax({url: page_files(page).html}).done(function(pageHtml) {
                    if('{{whole_docs}}'=='True') {
                        pageHtml = $(pageHtml).get(7);
                    }
                    if(!$.isEmptyObject(pageHtml)) {				
                        $(pageHtml).find('img').each(function() {
                            var sr = this.src;
                            sr = sr.replace('{{bookdir}}', '{{bookdir}}/html');
                            $(this).attr('src',sr);
                        });
                        pageElement.find('.page-html').html(pageHtml);
                    }
                    else {
                        pageElement.find('.page-html').remove();
                    }   
               }).fail(function() {
                   pageElement.find('.page-html').remove();    
               });
		    }
        }

		function addPage(page, book) {
			var id, pages = $('.flipbook').turn('pages');
			var pageElement = $('<div/>').html('<div class="loader"></div><div class="spine-gradient">{{#has_texts}}<div class="page-html"></div>{{/has_texts}}');
			if(page_files(page).hard) {
				pageElement.addClass('hard');
			}
		    if (book.turn('addPage', pageElement, page))  {
				loadPage(page, pageElement);
			}
		}
        
		$('.flipbook').data('displayMode', 'scan');
        $('#enlarge').click(function() {
            var z = $('.flipbook').turn('zoom'),
                w = $('.textuali-container').width();
            if(z > 1) {
                $('.flipbook').turn('zoom', 1);
                $(this).find('span').removeClass('glyphicon-resize-small').addClass('glyphicon-resize-full');
                $(this).attr('title', 'zoom in');
                $('.textuali-container').width(w/1.5);
            }
            else {
                $('.flipbook').turn('zoom', 1.5);
                $(this).find('span').removeClass('glyphicon-resize-full').addClass('glyphicon-resize-small');
                $(this).attr('title', 'zoom out');
                $('.textuali-container').width(Math.ceil(w*1.5));
            }
        });
        
        $('#flb-next').click(function() {
            $('.flipbook').turn('next');
        });
        
        $('#flb-prev').click(function() {
            $('.flipbook').turn('previous');
        });
        
        $('.mode-toggle').click(function() {
            var d=$('.flipbook').data();
            if(this.id == 'showhtmls' && d.displayMode == 'scan')  {
                d.displayMode = 'html';
           }
           else if(this.id == 'showscans' && d.displayMode == 'html') {
                d.displayMode = 'scan';
           }
           toggleHtml($('.flipbook').turn('view'));
        });
        
        {{#toc}}
        $('#totoc').click(function() {
            $('.flipbook').turn('page',{{toc}});
            Hash.go('page/{{toc}}');
        });
        {{/toc}}
        
      
        function toggle_html(btn) {
            $(btn).parent().parent().find('iframe').each(function() {
                $(this).css('height',($(this).parent().parent().height()-80)+'px');
                $(this).parent().toggleClass('hidden');
            });
        }
        
        function show_html(pages) {
            var tar; 
            for (i in pages) {
                tar = find_html_div(pages[i]).add('.page-html');
                tar.each(function() {
                    var oldh = $(this).height(),
                        newh = $(this).find('.pagelive').height(); 
                    $(this).closest('.page').css('overflow-y','scroll');
                    //$(this).removeClass('hidden').find('iframe').css('height',($(this).closest('.page-wrapper').height()-80)+'px');
                    $(this).removeClass('hidden').height(Math.max(oldh,newh)); 
                });
            }
        }
        
        function hide_html(pages) {
            for (i in pages) {
                find_html_div(pages[i]).add('.page-html').addClass('hidden').closest('.page').css('overflow-y','hidden');
            }
        }    
       
        function find_html_div(n) {
            return $('.page.p'+n).find('.page-html');
        }
        
        function toggleHtml(pages) {
            var displayMode = $('.flipbook').data('displayMode');
            if(displayMode == 'scan') {
                hide_html(pages);
            }
            else if(displayMode == 'html') {
                show_html(pages);
            }
        }
        
        function loadApp() {
           //Create the flipbook
           //var book_height=Math.floor($(document).height()*0.9);
           //var book_width=Math.floor(book_height*2*1024.0/1628.0);
           var  book_width = Math.min(Math.floor($(window).width()*0.65),1024),
                im = $('<img src="jpg/{{frontjpg}}"/>').get(0),
                ratio = im.naturalHeight/(2*im.naturalWidth);
           if($(window).width() >= 1850) {
               book_width = 1400;
           }

           var book_height=Math.floor(book_width*ratio);
           $('.flipbook').turn({
                width:book_width,
                height:book_height,
                elevation: 50,
                duration:2000,
                pages: {{pages}},
                direction: "rtl",
                // Enable gradients
                gradients: true,
                // Auto center this flipbook
                autoCenter: true,
                when: {
                    {{#toc}}
                    'turned': function(event, page, pages) {
                        if(page == {{toc}}) {
                            Hash.go('page/{{toc}}');
                        }
                    },
                    {{/toc}}
                    'start' : function(event,pageObject,corner) {
                        toggleHtml(pageObject.turn.turn('view'));                        
                    },
					'missing': function (e, pages) {
						for (var i = 0; i < pages.length; i++) {
							addPage(pages[i], $(this));
						}					
					}
                }                 
            });
 
            for(var i=1;i<$('.flipbook').turn('pages');i++) {
                $('#gotopage').append('<li><a href="'+Hash.get('page/'+i)+'">page '+i+'</a></li>');
            }

            // URIs
            Hash.on('^page\/([0-9]*)$', {
                yep: function(path, parts) {
                    var page = parts[1];
                    if (page!==undefined) {
                        if ($('.flipbook').turn('is'))
                            $('.flipbook').turn('page', page);
                    }
                },
                nop: function(path) {
                    if ($('.flipbook').turn('is'))
                        $('.flipbook').turn('page', 2);
                }
            });

            // Arrows
            $(document).keydown(function(e){
                var previous = 37, next = 39;
                switch (e.keyCode) {
                    case previous:
                        $('.flipbook').turn('previous');
                    break;
                    case next:
                        $('.flipbook').turn('next');
                    break;
                }
            });
        } // loadApp
        
        // Load the HTML4 version if there's not CSS transform
        $(function() {
            yepnope({
                test : Modernizr.csstransforms,
                yep: ['{{topdir}}vendor/turnjs4/lib/turn.js'],
                nope: ['{{topdir}}vendor/turnjs4/lib/turn.html4.min.js'],
                //both: ['{{topdir}}css/responsive.css'],
                complete: loadApp
            });
        });      
  </script>
</body>
</html>
