<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="{{language}}" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="{{language}}" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="{{language}}" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="{{language}}" class="ie9"> <![endif]-->
<!--[if !IE]><!-->

<html lang="{{language}}">
<!--<![endif]-->
<head>
	<meta name="robots" content="noindex, nofollow">
    <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width = 1050, user-scalable = no">
	<title>{{book_nicename}}</title>
	<link href="{{topdir}}bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="{{coddir}}css/basic.css" rel="stylesheet" type="text/css">
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
		<script src="html5shiv.min.js"></script>
		<script src="respond.min.js"></script>
	<![endif]-->
	<script src="{{topdir}}vendor/turnjs4/lib/hash.js" type="text/javascript"></script>
	</head>

<body>
    <!--<span class="hidden flb-prev glyphicon-chevron-right glyphicon largenav"></span>
    <span class="hidden flb-next glyphicon-chevron-left largenav glyphicon"></span>-->
    <img class="hidden flb-prev largenav" src="/media/right-arrow.png" />
    <img class="hidden flb-next largenav" src="/media/left-arrow.png" />
    <div class="textuali-container" style="direction:rtl">
        <div class="row" id="buttons-row">
            <div class="text-center" >
                <div class="btn-group btn-group-xs">
                    <button title="{{book_nicenamei}}" type="button" class="btn btn-primary">{{book_nicename}}</button>
                    <button title="{{book_nicenamei}}" type="button" class="btn btn-info">{{authnice}}</button>
                </div>
                <div class="btn-group btn-group-xs">
                    {{#has_texts}}
                     <button title="show scan image of pages" type="button" id="showscans" class="btn btn-default mode-toggle" >
                        <span class="glyphicon glyphicon-picture"></span>
                     </button>
                      <button title="show pages as text" type="button" id="showhtmls" class="btn btn-default mode-toggle">
                        <span class="glyphicon glyphicon-font"></span>
                     </button>
                     {{/has_texts}}
                    <button title="zoom in" type="button" id="enlarge" class="btn btn-default" >
                        <span class="glyphicon glyphicon-resize-full"></span>
                     </button>
                </div>
                <div class="btn-group btn-group-xs">
                    <button title="next page" type="button" class="btn flb-next btn-default">
                        <span class="glyphicon glyphicon-chevron-left"></span>
                    </button>
                    {{#toc}}
                    <button type="button" id="totoc" title="go to table of contents page" class="btn btn-default dropdown-toggle jpg-toc" data-toggle="dropdown">
                        <span class="glyphicon glyphicon-list"></span>
                    </button>
                      

                    <!--<button title="go to table of contents page" type="button" class="btn btn-default" id="totoc">
                        <span class="glyphicon glyphicon-list"></span>
                    </button>-->
                    {{/toc}}
                    <button id="gotopage-trigger" type="button" data-popper="#gotopage-popover" class="btn btn-default">
                        <span class="caret"></span> :go to
                    </button>
                    <button title="previous page" type="button" class="btn btn-default flb-prev" >
                        <span class="glyphicon glyphicon-chevron-right"/>
                    </button>
                </div>
                <div class="btn-group btn-group-xs">
                    <button title="download pdf" href="{{book_shortname}}.pdf" type="button" class="btn btn-default" id="download-pdf">
                        <span class="glyphicon glyphicon-download-alt"></span>
                    </button>
                    <button title="tag cloud" type="button" class="btn btn-default" id="tag-cloud">
                        <span class="glyphicon glyphicon-cloud"></span>
                    </button>
                    <button title="share this {{type}}" type="button" class="btn btn-default" id="share">
                        <span class="glyphicon glyphicon-transfer"></span>
                    </button>        
                </div>
                <div class="btn-group btn-group-xs">
                    {{#has_search}}
                    <button type="button" id="search-trigger" class="btn btn-default" data-popper="#search-popover">
                        <span class="glyphicon glyphicon-search"></span>
                    </button>
                    {{/has_search}}
                    <button title="previous menu" type="button" class="btn btn-default" id="flb-prev">
                        previous menu?
                    </button>   
                    <div class="dropdown-menu">
                        <input type="text" class="form-control" placeholder="search">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!--<div id="flipbook-wrapper">-->
                <div class="flipbook-viewport">
                    <div class="flipbook-container">   
                        <div class="flipbook">
							{{#hard_cover}}
							<div class="hard" style="background-image:url(jpg/{{bookdir}}p000a.jpg)"></div>
							<div class="hard" style="background-image:url(jpg/{{bookdir}}p000b.jpg)"></div> 
							{{/hard_cover}}
							{{^hard_cover}}                             
							<div style="background-image:url(jpg/{{frontjpg}}); background-size: contain">
								<div class="page-html hidden"></div>
							</div>
							{{/hard_cover}}          				
                        </div><!-- flipbook -->          
                   	</div>
                </div><!--flipbook-viewport -->
            <!--</div>-->
        </div><!-- .row -->
    </div><!-- .container -->

    <div id="gotopage-popover" data-trigger="#gotopage-trigger" class="popover">
        <form id="gotopage-form" class="form-inline">
            <input type="text" maxlength="5" class="form-control" placeholder="#page"/>
            <button type="submit" class="btn btn-primary" >go</button>
        </form>
         <div class="error-message hide">please enter only numbers between 1 and {{pages}}</div>
    </div>
    {{#has_search}}
    <div id="search-popover" data-trigger="#search-trigger" class="popover">
        <form id="search-form" class="form-inline">
            <input type="text" name="q" maxlength="20" class="form-control" placeholder="חפש"/>
            <button type="submit" class="btn btn-primary" >חפש</button>
        </form>
        <div id="search-results" class="fade open"></div>
        <div class="error-message hide"></div>
    </div>
    {{/has_search}}
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="{{topdir}}vendor/jquery-1.11.1.min.js" type="text/javascript"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{{topdir}}vendor/ie10-viewport-bug-workaround.js" type="text/javascript"></script>
    <script src="{{topdir}}vendor/turnjs4/extras/modernizr.2.5.3.min.js" type="text/javascript"></script>
    <script src="{{topdir}}bootstrap/js/bootstrap.min.js" type="text/javascript"></script> 
    <script src="{{topdir}}bootstrap/js/bootstrap-modal-popover.js" type="text/javascript"></script> 
    <script type="text/javascript">
        var first_flipto = location.href.match(/(\/#page\/)(\d*)$/);
        $('.page_end').click(function(c) {
            c.preventDefault();
        }); 
        $(window).resize(function() {
            var rememberme = {page:  $('.flipbook').turn('page'), displaymode : $('.flipbook').data('displayMode')};
            $('.flipbook').turn('destroy');
            loadApp();
            var book = $('.flipbook');
            book.data('displayMode',rememberme.displaymode);
            //toggleHtml();
            Hash.go('page/'+rememberme.page);
            book.turn('page',rememberme.page);
            for(p in book.turn('view')) {
                addPage(p,book);
            }
            toggleHtml(); 
        });
    
        $('#download-pdf').click(function() {
            var pdf = $(this).attr('href'),
                h = location.href;
            if(h.indexOf('#') > 0) {
                h = h.substr(0,h.indexOf('#'));
            }
            if(undefined != pdf) {
                window.open(h+"{{authdir}}-{{bookdir}}-"+pdf, "{{book_nicename}} PDF", "width=600, height=400" );
            }
        });
        
        $('[data-popper]').click(function() {
            $($(this).data('popper')).modalPopover('toggle');
        });
        
        $('.popover').each(function() {
            $(this).modalPopover({
                target: $(this).data('trigger'),
                placement: 'bottom'
            });
        });
        
        $('#gotopage-form').submit(function() {
            var v = $(this).find('input').val();
            if(parseInt(v) <= {{pages}} && parseInt(v) > 0) {
                $('.flipbook').turn('page',v);
            }
            else {
                $(this).siblings('.error-message').fadeIn(300).delay(4000).fadeOut(300);
            }
            return false;
        });
        
        
        $('#search-form').submit(function() {
            $('#search-results').removeClass('in');
            var query = $(this).serialize();
            $.ajax({
                url: 'http://textuali.com/search/websearch.py/?pretty=1&f={{authdir}}-{{bookdir}}&'+query,
                DataType: 'json'
            }).done(function(results) {
                $('#search-results').html(process_search_results(results)).addClass('in');
            }).fail(function(err) {
               $(this).siblings('.error-message').fadeIn(300).delay(4000).fadeOut(300);
           });
           return false; 
        });
        
        function filename2pagenum(filename) {
            var ans="";
            var n = filename.match(/\d+p0*([1-9]\d*)$/);
            if(n != null && n.length > 1) {
                ans= n[1];
            }
            return ans;
        } 
        function get_toc(pagenum) {
            $.ajax({url: page_files(pagenum).html}).done(function(pageHtml) {
                var toc_list = $('<ul class="toc-list dropdown-menu"/>');
                $(pageHtml).find('.toc-list li').each(function() {
                    toc_list.append(this);
                });
                $('#totoc').after(toc_list);
            });
        }
        function process_search_results(results) {
            var htm = '<h5>תוצאות חיפוש עבור "'+results.q+'"</h5>';
            if(results.status == 'success') {
                if(results.matches.length > 0) {
                    htm += '<ul class="toc-list">';
                    var m = results.matches;
                    for(var res in m) {
                        htm += '<li><span class="search-results-pagenum">עמ\' ' + filename2pagenum(m[res].id)+'</span>';
                        htm += '<a class="toc-link search-result" href="#page/'+($.inArray(m[res].id,{{page_list}}) + 1);
                        htm += '?q='+results.q+'">'+m[res].match+'</a></li>';
                    }
                    htm += '</ul>';
                }
                else {
                    htm = 'sorry, no matches found';
                } 
           }
           else if(results.status == 'fail') {
               htm = results.error;
           }
           else {
               htm = 'unknown error';
           }
           return htm;
        } 
        
        $('body').mousedown(function(c) {
            if($(this).hasClass('modal-open')) {
                var exclude1 = $('#gotopage-trigger').add($('#gotopage-popover').find('*').andSelf());
                var exclude2 = $('#search-trigger').add($('#search-popover').find('*').andSelf());
                if(!exclude1.is(c.target)) {
                    $('#gotopage-popover').modalPopover('hide');
                }
                if(!exclude2.is(c.target)) {
                    $('#search-popover').modalPopover('hide');
               }
            }
       }); 
        if('{{language}}' == 'he') {
			$('body').css('direction', 'rtl');
		}
		
        function page_files(page) {
			/*var zeros = '00', hard = false;
			if(page > 9) {
				zeros = '0';
			}
			if(page > 99) {
				zeros = '';
			}
			var filename = '{{bookdir}}p'+ zeros + page;
			if('{{hard_cover}}' == 'True' && page > {{pages}} - 2) {
				filename = '{{bookdir}}p999'+(page == {{pages}} ? 'z' : 'y');
				hard = true;
			}*/
            var filename = {{page_list}}[page-1], 
                hard = /[a-z]/.test(filename.slice(-1));
			return {jpg : 'jpg/'+ filename + '.jpg', html : 'html/' + filename + '.htm', hard : hard};
		}
			
		
        function loadPage(page, pageElement) {
			pageElement.css('background-image','url('+page_files(page).jpg+')');			
            foundHtml = false;
			if('{{has_texts}}' == 'True' ) {			
				$.ajax({url: page_files(page).html}).done(function(pageHtml) {
                    if('{{whole_docs}}'=='True') {
                        pageHtml = $(pageHtml).get(7);
                    }
                    if(!$.isEmptyObject(pageHtml)) {				
                        $(pageHtml).find('img').each(function() {
                            var sr = this.src;
                            sr = sr.replace('{{bookdir}}', '{{bookdir}}/html');
                            $(this).attr('src',sr);
                        });
                        pageElement.find('.page-html').html(pageHtml);
                    }
                    else {
                        pageElement.find('.page-html').remove();
                    }   
               }).fail(function() {
                   pageElement.find('.page-html').remove();    
               });
		    }
        }

		function addPage(page, book) {
			var id, pages = $('.flipbook').turn('pages');
			var pageElement = $('<div/>').html('<div class="loader"></div><div class="spine-gradient">{{#has_texts}}<div class="page-html"></div>{{/has_texts}}');
			if(page_files(page).hard) {
				pageElement.addClass('hard');
			}
		    if (book.turn('addPage', pageElement, page))  {
				loadPage(page, pageElement);
			}
		}
        function highlight_search(page,query) {
            var target = $('.p'+page).find('.page-html');
            if(target.length > 0) {
                var rawhtml = target.html();
                var newhtml = rawhtml.replace(query,'<strong class="in-page-highlight whole">'+query+'</strong>');
                var sq = query.split(" ");
                for(w in sq) {
                    newhtml = newhtml.replace(sq[w], '<strong class="in-page-highlight">'+sq[w]+'</strong>');
                }
                target.html(newhtml);
            }
            return 1;
        } 
		$('.flipbook').data('displayMode', 'scan');
        $('#enlarge').click(function() {
            if($(this).hasClass('btn-danger')) {
                $(this).removeClass('btn-danger');
                $('.flipbook').turn('zoom', 1).animate({left: '-20px', top: '-20px'},500).turn('disable',false);
                $('.textuali-container').width($('.flipbook').width() + 20);
            }
            else {
                $(this).addClass('btn-danger');
                $('.flipbook').turn('disable',true);
            }
            /*var z = $('.flipbook').turn('zoom'),
                w = $('.textuali-container').width();
            if(z > 1) {
                $('.flipbook').turn('zoom', 1);
                $(this).find('span').removeClass('glyphicon-resize-small').addClass('glyphicon-resize-full');
                $(this).attr('title', 'zoom in');
                $('.textuali-container').width(w/1.5);
            }
            else {
                $('.flipbook').turn('zoom', 1.5);
                $(this).find('span').removeClass('glyphicon-resize-full').addClass('glyphicon-resize-small');
                $(this).attr('title', 'zoom out');
                $('.textuali-container').width(Math.ceil(w*1.5));
            }*/
        });
        $('.flipbook').click(function(c) {
            var dist_from_center = c.pageX - $('.flipbook').offset().left - $('.flipbook').width()/2;
            var dist_from_middle = c.pageY - $('.flipbook').offset().top - $('.flipbook').height()/2;
            if($('#enlarge').hasClass('btn-danger')) {
                var z = $('.flipbook').turn('zoom');
                if(z > 1) {
                    $('.flipbook').turn('zoom', 1).animate({left: '-20px', top: '-20px'},500).turn('disable',false);
                    $('.textuali-container').width($('.flipbook').width() + 20);
                    $('#enlarge').removeClass('btn-danger');
                }
                else {
                    $('.textuali-container').width($(this).width()*2 + 40);
                    $('.flipbook').turn('zoom', 2).animate({left : -2* dist_from_center+'px', top : -2 * dist_from_middle +'px'});
                }
            }
        });

        /*$('.flipbook').mouseover(function(e) {
            var dist_from_center = e.pageX - $('.flipbook').offset().left - $('.flipbook').width()/2;
            var dist_from_top = e.pageY - $('.flipbook').offset().top;
            var dist_from_bottom = $('.flipbook').height() - dist_from_top;
            if(Math.abs(dist_from_center)/$('.flipbook').width() > 0.45 && dist_from_top > 100 && dist_from_bottom > 100 && $('.flipbook').data().displayMode == 'scan') {
                $('.flipbook').turn("peel", dist_from_center > 0 ? 'tr' : 'tl').bind('mousedown', function() {
                    $(this).turn(dist_from_center > 0 ? 'previous' : 'next');
                });
            }
        });*/
        
        $('.flb-next').click(function() {
            $('.flipbook').turn('next');
        });
        
        $('.flb-prev').click(function() {
            $('.flipbook').turn('previous');
        });
        
        $('.mode-toggle').click(function() {
            $('.mode-toggle').removeClass('on');
            var d=$('.flipbook').data();
            if(this.id == 'showhtmls' && d.displayMode == 'scan')  {
                d.displayMode = 'html';
                $('#showhtmls').addClass('on');
           }
           else if(this.id == 'showscans' && d.displayMode == 'html') {
                d.displayMode = 'scan';
                $('#showscans').addClass('on');
           }
           toggleHtml($('.flipbook').turn('view'));
        });
        
        {{#toc}}
        $('#totoc').click(function() {
            if(!$(this).hasClass('jpg-toe')) {  
                $('.flipbook').turn('page',{{toc}});
            }
        });
        {{/toc}}
        
      
        function toggle_html(btn) {
            $(btn).parent().parent().find('iframe').each(function() {
                $(this).css('height',($(this).parent().parent().height()-80)+'px');
                $(this).parent().toggleClass('hidden');
            });
        }
        
        function show_html(pages) {
            var tar; 
            for (i in pages) {
                tar = find_html_div(pages[i]).add('.page-html').filter(function() {
                    return $(this).html() != "";
                });
                tar.each(function() {
                    $(this).closest('.page').css({'overflow-y': 'auto', 'background-size': '0 0'});
                    $(this).removeClass('hidden');
                    var l = $(this).find('.pagelive').height() + 20,
                        t = $(this).height(),
                        p = $(this).closest('.page').height(),
                        h = Math.max(t,p,l);
                    //$(this).removeClass('hidden').find('iframe').css('height',($(this).closest('.page-wrapper').height()-80)+'px');
                    $(this).height(h); 
                    if(l < h) {
                        $(this).find('.pagelive').height(h);
                    }
                });
            }
            $('#totoc').attr('data-toggle', '').removeClass('jpg-toc');
        }
        
        function hide_html(pages) {
            for (i in pages) {
                find_html_div(pages[i]).add('.page-html').addClass('hidden').closest('.page').css({
                    'overflow-y' : 'hidden',
                    'background-size' : '100% 100%'
                });
            }

            $('#totoc').attr('data-toggle', 'dropdown').addClass('jpg-toc');
        }    
       
        function find_html_div(n) {
            return $('.page.p'+n).find('.page-html');
        }
        
        function toggleHtml(pages) {
            var displayMode = $('.flipbook').data('displayMode');
            if(displayMode == 'scan') {
                hide_html(pages);
            }
            else if(displayMode == 'html') {
                show_html(pages);
            }
        }
        
        function loadApp() {
            $('.largenav').addClass('hidden');
            //Create the flipbook
            //var book_height=Math.floor($(document).height()*0.9);
            //var book_width=Math.floor(book_height*2*1024.0/1628.0);
            var  book_height = Math.floor(($(window).height() - $('#buttons-row').height()) * 0.95),
                screen_ratio = $(window).width()/$(window).height(),
                book_width,
                openbook_ratio = parseFloat({{openbook_ratio}});
                 
            if(typeof(openbook_ratio) != "number" || openbook_ratio == 0) {
                im = $('<img src="jpg/{{frontjpg}}"/>').get(0);
                openbook_ratio = (2*im.naturalWidth)/im.naturalHeight;
            }
            
            if(Math.abs(1 - openbook_ratio/screen_ratio) > Math.abs(1 - screen_ratio/openbook_ratio)) {
                openbook_ratio = 1/openbook_ratio;
                book_width = Math.floor($(window).width() * 0.95);
                book_height = Math.floor(book_width*openbook_ratio);
            }   
            else {
                book_width=Math.floor(book_height*openbook_ratio);
            }
            var screen_marge = Math.floor(($(window).width() - book_width)/2);
            var largenav_offset = (screen_marge - 85)+'px';
            
            $('.textuali-container').width(book_width + 20);
            $('.flb-next.largenav').css('left', largenav_offset);
            $('.flb-prev.largenav').css('right',largenav_offset);
            $('.largenav').removeClass('hidden');
            $('.flipbook').turn({
                width:book_width,
                height:book_height,
                elevation: 50,
                duration:2000,
                pages: {{pages}},
                direction: "rtl",
                // Enable gradients
                gradients: true,
                // Auto center this flipbook
                autoCenter: true,
                when: {
                    'turned': function(event, page, pages) {
                        if(Hash.fragment() != "" || page > 2 ) {
                            var searchq = Hash.fragment().match(/\?q=(.*)$/);
                            if(searchq != null && searchq.length == 2) {
                                show_html(pages);
                                for(var p in pages) {
                                    highlight_search(pages[p],decodeURIComponent(searchq[1])),$('.p'+page);
                                }
                            }
                            Hash.go('page/'+page);
                        } 
                        //$(this).unbind('mousedown');
                        $('.flb-next, .flb-prev').show();
                        if(page == $(this).turn('pages')) {
                            $('.flb-next').hide();
                        }
                        if(page == 1) {
                            $('.flb-prev').hide();
                        }
                    },
                    'start' : function(event,pageObject,corner) {
                        toggleHtml(pageObject.turn.turn('view'));                        
                    },
					'missing': function (e, pages) {
						for (var i = 0; i < pages.length; i++) {
							addPage(pages[i], $(this));
						}					
					},
                    'turning' : function(event, page, view) {
                        $('.popover').modalPopover('hide');
                    }
                }                 
            });
            
            loadPage(1,$('.flipbook').find('div').eq(0));
            
            /*for(var i=1;i<=$('.flipbook').turn('pages');i++) {
                $('#gotopage').append('<li><a href="'+Hash.get('page/'+i)+'">page '+i+'</a></li>');
            }*/
            
            // URIs
            Hash.on('^page\/([0-9]*)\/\?(.*)$', {
                yep: function(path, parts) {
                    var page = parts[1];
                    if (page!==undefined) {
                        if ($('.flipbook').turn('is'))
                            $('.flipbook').turn('page', page);
                    }
                },
                nop: function(path) {
                   if ($('.flipbook').turn('is'))
                       $('.flipbook').turn('page', 2);
                }
            });

            // Arrows
            $(document).keydown(function(e){
                var previous = 37, next = 39;
                switch (e.keyCode) {
                    case previous:
                        $('.flipbook').turn('previous');
                    break;
                    case next:
                        $('.flipbook').turn('next');
                    break;
                }
            });
            
            if(first_flipto != null && first_flipto[2] !== "") {
                Hash.go('page/'+first_flipto[2]);
            }

            if(parseInt({{toc}}) > 0) {
                get_toc({{toc}});
            }
        } // loadApp
        
        // Load the HTML4 version if there's not CSS transform
        $(function() {
            yepnope({
                test : Modernizr.csstransforms,
                yep: ['{{topdir}}vendor/turnjs4/lib/turn.js'],
                nope: ['{{topdir}}vendor/turnjs4/lib/turn.html4.min.js'],
                //both: ['{{topdir}}css/responsive.css'],
                complete: loadApp
            });
        });     
     </script> 
</body>
</html>
